{% extends 'estimation/base.html' %}

{% block title %}{{ session.name }}{% endblock %}

{% block header_right %}
<div class="participants">
    <span class="participant admin">
        <span class="online-indicator"></span>
        {{ participant.name }} (You{% if is_admin %} - Admin{% endif %})
    </span>
</div>
{% endblock %}

{% block content %}
<div x-data="sessionApp()">
    <!-- Session Info -->
    <div class="card">
        <div class="flex-between">
            <div>
                <h2>{{ session.name }}</h2>
                <p class="text-secondary">
                    Session Link: <code>{{ request.build_absolute_uri }}</code>
                    <button onclick="navigator.clipboard.writeText('{{ request.build_absolute_uri }}')" class="btn btn-small" style="margin-left: 1rem;">Copy Link</button>
                </p>
            </div>
        </div>
    </div>

    <!-- Current Voting User Story -->
    <div x-show="isVoting && currentUserStory" class="card" style="background-color: #e3f2fd;">
        <h3>Voting: <span x-text="currentUserStory?.title"></span></h3>
        <p class="text-secondary" x-text="currentUserStory?.description"></p>

        <!-- Timer -->
        <div x-show="votingStartedAt" class="alert alert-info">
            <p>Time remaining: <strong x-text="timeRemaining"></strong> seconds</p>
        </div>

        <!-- Vote on all tasks -->
        <div style="margin-top: 1.5rem;">
            <template x-for="task in votingTasks" :key="task.id">
                <div class="card" style="background-color: white; margin-bottom: 1rem;">
                    <h4 x-text="task.title"></h4>
                    <p class="text-secondary" style="font-size: 0.875rem;" x-text="task.description"></p>

                    <div style="margin-top: 0.75rem;">
                        <span x-text="task.votes_count"></span> / <span x-text="totalParticipants"></span> voted
                    </div>

                    <!-- Voting Cards for this task -->
                    <template x-if="!task.user_has_voted">
                        <div>
                            <h5 style="margin-top: 1rem;">Select your estimate:</h5>
                            <div class="poker-cards">
                                <template x-for="card in pokerCards" :key="card">
                                    <div class="poker-card"
                                         :class="{ 'selected': selectedVotes[task.id] === card }"
                                         @click="selectCardForTask(task.id, card)"
                                         x-text="card == 999 ? '?' : card">
                                    </div>
                                </template>
                            </div>
                            <button @click="castVote(task.id)"
                                    :disabled="!selectedVotes[task.id]"
                                    class="btn btn-success btn-small">
                                Submit Vote for This Task
                            </button>
                        </div>
                    </template>

                    <template x-if="task.user_has_voted">
                        <div class="alert alert-success" style="margin-top: 1rem;">
                            ✓ You have voted on this task!
                        </div>
                    </template>
                </div>
            </template>
        </div>

        {% if is_admin %}
        <div class="mt-2">
            <button @click="endVoting()" class="btn btn-secondary btn-small">End Voting Now (Admin Override)</button>
        </div>
        {% endif %}
    </div>

    <!-- Voting Results (shown after voting ends) -->
    <div x-show="votingResults" class="card">
        <h3>Voting Results</h3>
        <template x-for="taskResult in votingResults" :key="taskResult.task_id">
            <div class="card" style="background-color: var(--bg-secondary); margin-bottom: 1rem;">
                <h4 x-text="taskResult.task_title"></h4>

                <div class="poker-cards" style="margin-top: 1rem;">
                    <template x-for="vote in taskResult.votes" :key="vote.participant__name">
                        <div class="poker-card selected" style="position: relative;">
                            <div style="font-size: 0.65rem; position: absolute; top: 5px; left: 0; right: 0; text-align: center;"
                                 x-text="vote.participant__name"></div>
                            <div style="margin-top: 15px;" x-text="vote.estimate == 999 ? '?' : vote.estimate"></div>
                        </div>
                    </template>
                </div>

                <p style="margin-top: 1rem;">
                    Average: <strong x-text="taskResult.average"></strong>
                </p>

                {% if is_admin %}
                <div class="mt-2">
                    <template x-if="!tasksWithEstimatesSet.includes(taskResult.task_id)">
                        <div>
                            <h5>Set Final Estimate:</h5>
                            <div class="poker-cards">
                                <template x-for="card in pokerCards" :key="card">
                                    <div class="poker-card"
                                         @click="setFinalEstimate(taskResult.task_id, card)"
                                         x-text="card == 999 ? '?' : card">
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                    <template x-if="tasksWithEstimatesSet.includes(taskResult.task_id)">
                        <div class="alert alert-success">
                            ✓ Final estimate set!
                        </div>
                    </template>
                </div>
                {% endif %}
            </div>
        </template>

        {% if is_admin %}
        <div class="mt-2" style="text-align: center;">
            <button @click="finishEstimating()" class="btn">Done - Continue to Next Story</button>
        </div>
        {% endif %}
    </div>

    <!-- Admin Controls -->
    {% if is_admin %}
    <div class="card">
        <h3>Admin Controls</h3>

        <div style="margin-bottom: 2rem;">
            <h4>Add User Story</h4>
            <form @submit.prevent="addUserStory()">
                <div class="input-group">
                    <label>User Story Title</label>
                    <input type="text" x-model="newUserStory.title" required placeholder="As a user, I want to...">
                </div>
                <div class="input-group">
                    <label>Description (optional)</label>
                    <textarea x-model="newUserStory.description" placeholder="Additional details..."></textarea>
                </div>
                <button type="submit" class="btn btn-small">Add User Story</button>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- User Stories and Tasks -->
    <div class="card">
        <h3>User Stories & Tasks</h3>

        {% for story in user_stories %}
        <div class="card" style="background-color: var(--bg-secondary);">
            <div class="flex-between">
                <h4>{{ story.title }}</h4>
                <div class="flex flex-gap" style="align-items: center;">
                    <span class="task-estimate">Total: {{ story.total_estimate }}</span>
                    {% if is_admin %}
                    <button @click="startVoting('{{ story.id }}')" class="btn btn-small"
                            :disabled="isVoting">
                        Start Voting on This Story
                    </button>
                    {% endif %}
                </div>
            </div>
            {% if story.description %}
            <p class="text-secondary" style="font-size: 0.875rem;">{{ story.description }}</p>
            {% endif %}

            <!-- Tasks -->
            <ul class="task-list" style="margin-top: 1rem;">
                {% for task in story.tasks.all %}
                <li class="task-item">
                    <div>
                        <strong>{{ task.title }}</strong>
                        {% if task.description %}
                        <p class="text-secondary" style="font-size: 0.875rem; margin-top: 0.25rem;">{{ task.description }}</p>
                        {% endif %}
                    </div>
                    <div class="flex flex-gap" style="align-items: center;">
                        {% if task.final_estimate is not None %}
                        <span class="task-estimate">{{ task.get_final_estimate_display }}</span>
                        {% else %}
                        <span class="text-secondary">Not estimated</span>
                        {% endif %}
                    </div>
                </li>
                {% endfor %}
            </ul>

            <!-- Add Task Form (Admin Only) -->
            {% if is_admin %}
            <div style="margin-top: 1rem;" x-data="{ showForm: false }">
                <button @click="showForm = !showForm" class="btn btn-secondary btn-small">
                    <span x-text="showForm ? 'Cancel' : '+ Add Task'"></span>
                </button>

                <form x-show="showForm" @submit.prevent="addTask('{{ story.id }}')" style="margin-top: 1rem;">
                    <div class="input-group">
                        <label>Task Title</label>
                        <input type="text" x-model="newTask.title" required placeholder="Implement login form">
                    </div>
                    <div class="input-group">
                        <label>Description (optional)</label>
                        <textarea x-model="newTask.description" placeholder="Additional details..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-small">Add Task</button>
                </form>
            </div>
            {% endif %}
        </div>
        {% empty %}
        <p class="text-secondary">No user stories yet. {% if is_admin %}Add one above to get started!{% endif %}</p>
        {% endfor %}
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    function sessionApp() {
        return {
            sessionId: '{{ session.id }}',
            participantId: '{{ participant.id }}',
            isAdmin: {% if is_admin %}true{% else %}false{% endif %},
            pokerCards: [0, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 999],
            selectedVotes: {},  // Map of task_id to selected card
            isVoting: false,
            currentUserStory: null,
            votingTasks: [],
            previousUserStoryId: null,
            totalParticipants: 1,
            votingStartedAt: null,
            timeRemaining: 60,
            votingResults: null,
            tasksWithEstimatesSet: [],  // Track which tasks have final estimates set
            timerInterval: null,
            newUserStory: {
                title: '',
                description: ''
            },
            newTask: {
                title: '',
                description: ''
            },

            init() {
                this.connectWebSocket();
                this.pollSessionState();
                setInterval(() => this.pollSessionState(), 2000);
            },

            connectWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const ws = new WebSocket(`${protocol}//${window.location.host}/ws/session/${this.sessionId}/`);

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleWebSocketMessage(data);
                };
            },

            handleWebSocketMessage(data) {
                if (data.type === 'vote_update') {
                    this.pollSessionState();
                }
            },

            async pollSessionState() {
                try {
                    const response = await fetch(`/session/${this.sessionId}/state/`);
                    const data = await response.json();

                    this.isVoting = data.is_voting;
                    this.totalParticipants = data.participants.length;

                    if (data.current_user_story) {
                        // Check if this is a new user story being voted on
                        if (this.previousUserStoryId !== data.current_user_story.id) {
                            // Reset voting state for new user story
                            this.selectedVotes = {};
                            this.votingResults = null;
                            this.tasksWithEstimatesSet = [];
                            this.timeRemaining = 60;

                            // Clear existing timer
                            if (this.timerInterval) {
                                clearInterval(this.timerInterval);
                                this.timerInterval = null;
                            }

                            this.previousUserStoryId = data.current_user_story.id;
                        }

                        this.currentUserStory = data.current_user_story;
                        this.votingTasks = data.voting_tasks;

                        // Check if voting ended and we have all votes
                        if (!this.isVoting && this.previousUserStoryId) {
                            // Voting just ended, we'll get results from the last vote
                        }
                    } else {
                        this.currentUserStory = null;
                        this.votingTasks = [];
                        this.previousUserStoryId = null;
                    }

                    if (data.voting_started_at && this.isVoting) {
                        this.startTimer(data.voting_started_at);
                    }
                } catch (error) {
                    console.error('Error polling session state:', error);
                }
            },

            startTimer(startTime) {
                if (this.timerInterval) return;

                this.timerInterval = setInterval(() => {
                    const now = new Date();
                    const start = new Date(startTime);
                    const elapsed = Math.floor((now - start) / 1000);
                    this.timeRemaining = Math.max(60 - elapsed, 0);

                    if (this.timeRemaining === 0) {
                        clearInterval(this.timerInterval);
                        this.timerInterval = null;
                        if (this.isAdmin) {
                            this.endVoting();
                        }
                    }
                }, 1000);
            },

            selectCardForTask(taskId, card) {
                this.selectedVotes[taskId] = card;
            },

            async castVote(taskId) {
                if (!this.selectedVotes[taskId]) return;

                const formData = new FormData();
                formData.append('estimate', this.selectedVotes[taskId]);
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                try {
                    const response = await fetch(`/task/${taskId}/cast-vote/`, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const data = await response.json();

                        // Check if voting ended automatically
                        if (data.voting_ended) {
                            this.votingResults = data.results;
                            this.tasksWithEstimatesSet = [];  // Reset for new results
                            this.isVoting = false;
                            this.currentUserStory = null;
                            this.votingTasks = [];
                            if (this.timerInterval) {
                                clearInterval(this.timerInterval);
                                this.timerInterval = null;
                            }
                        } else {
                            // Refresh state to update vote counts
                            this.pollSessionState();
                        }
                    }
                } catch (error) {
                    console.error('Error casting vote:', error);
                }
            },

            async startVoting(userStoryId) {
                const formData = new FormData();
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                try {
                    const response = await fetch(`/user-story/${userStoryId}/start-voting/`, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        this.pollSessionState();
                    }
                } catch (error) {
                    console.error('Error starting voting:', error);
                }
            },

            async endVoting() {
                const formData = new FormData();
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                try {
                    const response = await fetch(`/session/${this.sessionId}/end-voting/`, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.votingResults = data.results;
                        this.tasksWithEstimatesSet = [];  // Reset for new results
                        this.isVoting = false;
                        this.currentUserStory = null;
                        this.votingTasks = [];
                        if (this.timerInterval) {
                            clearInterval(this.timerInterval);
                            this.timerInterval = null;
                        }
                    }
                } catch (error) {
                    console.error('Error ending voting:', error);
                }
            },

            async setFinalEstimate(taskId, estimate) {
                const formData = new FormData();
                formData.append('estimate', estimate);
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                try {
                    const response = await fetch(`/task/${taskId}/set-estimate/`, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        // Add to the list of tasks with estimates set
                        if (!this.tasksWithEstimatesSet.includes(taskId)) {
                            this.tasksWithEstimatesSet.push(taskId);
                        }
                        // Don't reload - let admin set estimates for other tasks
                    }
                } catch (error) {
                    console.error('Error setting estimate:', error);
                }
            },

            finishEstimating() {
                // Clear results and reload to show updated estimates
                this.votingResults = null;
                this.tasksWithEstimatesSet = [];
                location.reload();
            },

            async addUserStory() {
                const formData = new FormData();
                formData.append('title', this.newUserStory.title);
                formData.append('description', this.newUserStory.description);
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                try {
                    const response = await fetch(`/session/${this.sessionId}/add-user-story/`, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        this.newUserStory = { title: '', description: '' };
                        location.reload();
                    }
                } catch (error) {
                    console.error('Error adding user story:', error);
                }
            },

            async addTask(userStoryId) {
                const formData = new FormData();
                formData.append('title', this.newTask.title);
                formData.append('description', this.newTask.description);
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                try {
                    const response = await fetch(`/user-story/${userStoryId}/add-task/`, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        this.newTask = { title: '', description: '' };
                        location.reload();
                    }
                } catch (error) {
                    console.error('Error adding task:', error);
                }
            }
        }
    }
</script>
{% endblock %}
